<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas Tech TravelCash</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/AoaA8WI.png">
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SortableJS para Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- SignalR Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #526D82;
        }
        .sortable-drag {
            opacity: 0.9 !important;
        }
        .description-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limita o texto a 2 linhas */
            -webkit-box-orient: vertical;
        }
        .task-card, .list-row {
            transition: background-color 0.5s ease-in-out, border-color 0.5s ease-in-out;
        }
        .task-card.highlight {
            background-color: #c8d3db !important; /* Um tom mais escuro que o fundo claro */
            border-color: #526D82 !important;
        }
        .dark .task-card.highlight {
            background-color: #3a4b5c !important; /* Um tom mais claro que o fundo escuro */
            border-color: #9DB2BF !important;
        }
        tr.highlight {
             background-color: #DDE6ED !important;
        }
         .dark tr.highlight {
             background-color: #526D82 !important;
        }
        /* Animação para Novos Cartões */
        @keyframes card-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .task-card.new-card { /* Usamos uma classe específica para animar apenas os novos */
            animation: card-fade-in 0.5s ease forwards;
        }
        .sortable-drag {
            opacity: 0.9 !important;
            /* Adicionamos a nossa nova animação aqui */
            animation: wobble 0.6s infinite ease-in-out;
            transform-origin: top center; /* Faz o cartão balançar a partir do topo */
        }

        /* Definição da animação de balanço */
        @keyframes wobble {
            0% { transform: rotate(0deg); }
            33% { transform: rotate(2deg); }
            66% { transform: rotate(-2deg); }
            100% { transform: rotate(0deg); }
        }
        .task-overdue {
            background-color: #FECACA !important; /* Tailwind's red-200 */
            border-color: #F87171 !important; /* Tailwind's red-400 */
        }
        .dark .task-overdue {
            background-color: #450A0A !important; /* Tailwind's red-950 */
            border-color: #DC2626 !important; /* Tailwind's red-600 */
        }

        .responsible-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #526D82; /* custom-dark */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .tag-remove-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tag-remove-btn:hover {
            background-color: rgba(0,0,0,0.4);
        }

        /* Estilos para a Animação de Revelação do Conteúdo */
        #main-content.content-hidden {
            opacity: 0;
            transform: translateY(-20px); /* Alterado para vir de cima */
        }

        #main-content.content-reveal {
            animation: reveal-content 1.5s ease-out forwards;
        }

        @keyframes reveal-content {
            from {
                opacity: 0;
                transform: translateY(-20px); /* Alterado para vir de cima */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

            </style>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'custom-darkest': '#27374D',
                        'custom-dark': '#526D82',
                        'custom-medium': '#9DB2BF',
                        'custom-light': '#DDE6ED',
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased bg-white dark:bg-custom-dark text-custom-darkest dark:text-custom-light">

    <div id="app">
        <!-- Cabeçalho -->
        <header class="p-4 z-10 bg-custom-darkest border-b border-custom-dark/50 sticky top-0">
            <div class="container mx-auto flex justify-between items-center flex-wrap gap-4">
                <!-- Grupo da Esquerda: Título e Filtro -->
                <div class="flex items-center gap-6">
                    <img src="https://i.imgur.com/rS6Xx7X.png" alt="TravelCash" class="h-8 w-auto">
                    <!-- Seletor de Visualização -->
                    <div id="view-switcher" class="flex items-center bg-custom-dark p-1 rounded-lg">
                        <button data-view="list" class="view-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors">Lista</button>
                        <button data-view="kanban" class="view-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors">Kanban</button>
                        <button data-view="archived" class="view-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors">Arquivados</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="responsibleFilter" class="text-custom-medium" title="Filtrar por responsável">
                            <i data-lucide="user-check" class="w-5 h-5"></i>
                        </label>
                        <select id="responsibleFilter" class="bg-custom-dark border-none text-custom-light rounded-md focus:ring-custom-medium focus:ring-2 focus:outline-none py-2 pl-3 pr-8">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="projectFilter" class="text-custom-medium" title="Filtrar por projeto">
                            <i data-lucide="folder-kanban" class="w-5 h-5"></i>
                        </label>
                        <select id="projectFilter" class="bg-custom-dark border-none text-custom-light rounded-md focus:ring-custom-medium focus:ring-2 focus:outline-none py-2 pl-3 pr-8">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                </div>
                
                <!-- Grupo da Direita: Ações e Configurações -->
                <div class="flex items-center gap-4">
                    <button id="addTaskBtn" class="bg-custom-light hover:bg-custom-medium text-custom-darkest font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>Nova Tarefa</span>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-lg text-custom-medium hover:bg-custom-dark/50 transition-colors">
                        <i id="theme-icon-light" data-lucide="sun" class="w-5 h-5 hidden"></i>
                        <i id="theme-icon-dark" data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
         <!-- Indicador de Carregamento -->
           <div id="loader-container" class="fixed inset-0 z-50 flex justify-center items-center bg-white dark:bg-custom-dark">
                <video id="loader-video" autoplay muted loop playsinline class="absolute top-0 left-0 w-full h-full object-cover">
                    <source src="https://syncboard.blob.core.windows.net/geral/Apresentação1.mp4" type="video/mp4">
                    O seu navegador não suporta vídeos.
                </video>
            </div>
        <main id="main-content" class="container mx-auto p-4 lg:p-6">
            <!-- Visualização Kanban -->
            <div id="kanbanView" class="hidden">
                <div id="board-columns" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Coluna A fazer -->
                    <div class="kanban-column bg-custom-light dark:bg-custom-darkest/40 p-4 rounded-lg flex flex-col">
                        <h2 class="font-bold text-lg mb-4 text-custom-darkest dark:text-custom-light">A fazer</h2>
                        <div class="task-list space-y-4 min-h-[100px] flex-grow" data-column-id="todo"></div>
                    </div>
                    <!-- Coluna Parado -->
                    <div class="kanban-column bg-custom-light dark:bg-custom-darkest/40 p-4 rounded-lg flex flex-col">
                        <h2 class="font-bold text-lg mb-4 text-custom-darkest dark:text-custom-light">Parado</h2>
                        <div class="task-list space-y-4 min-h-[100px] flex-grow" data-column-id="stopped"></div>
                    </div>
                    <!-- Coluna Em Andamento -->
                    <div class="kanban-column bg-custom-light dark:bg-custom-darkest/40 p-4 rounded-lg flex flex-col">
                        <h2 class="font-bold text-lg mb-4 text-custom-darkest dark:text-custom-light">Em Andamento</h2>
                        <div class="task-list space-y-4 min-h-[100px] flex-grow" data-column-id="inprogress"></div>
                    </div>
                    <!-- Coluna Em Homologação -->
                    <div class="kanban-column bg-custom-light dark:bg-custom-darkest/40 p-4 rounded-lg flex flex-col">
                        <h2 class="font-bold text-lg mb-4 text-custom-darkest dark:text-custom-light">Em Homologação</h2>
                        <div class="task-list space-y-4 min-h-[100px] flex-grow" data-column-id="homologation"></div>
                    </div>
                </div>
            </div>

            <!-- Visualização em Lista -->
            <div id="listView" class="hidden">
                <!-- O conteúdo da lista será gerado aqui -->
            </div>

            <!-- Vista de Tarefas Arquivadas -->
            <div id="archivedView" class="hidden">
                <!-- O conteúdo da lista de arquivados será gerado aqui -->
            </div>
        </main>
    </div>

    <!-- Modal para Adicionar/Editar Tarefa -->
    <div id="taskModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-custom-light dark:bg-custom-darkest border border-custom-medium/50 dark:border-custom-dark/50 rounded-xl shadow-2xl w-full max-w-lg">
            <form id="taskForm">
                <div class="p-6 border-b border-custom-medium/30 dark:border-custom-dark/50">
                    <h2 id="modalTitle" class="text-2xl font-bold text-custom-darkest dark:text-custom-light">Nova Tarefa</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="taskTitle" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Título</label>
                        <input type="text" id="taskTitle" class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light" required>
                    </div>
                    <div>
                        <label for="taskDescription" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Descrição</label>
                        <textarea id="taskDescription" rows="3" class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="taskResponsible" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Responsável(eis)</label>
                        <div id="responsible-input-container" class="relative flex items-center flex-wrap gap-2 p-2 shadow-sm border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full min-h-[46px]">
                            <!-- As tags dos responsáveis serão inseridas aqui pelo JavaScript -->
                            <input type="text" id="taskResponsible" class="flex-grow bg-transparent focus:outline-none text-custom-darkest dark:text-custom-light" placeholder="Adicionar responsável..." autocomplete="off">
                        </div>
                        <div id="responsible-suggestions" class="absolute z-20 w-full bg-white dark:bg-custom-darkest border border-custom-medium dark:border-custom-dark rounded-md mt-1 hidden shadow-lg max-h-40 overflow-y-auto"></div>
                    </div>
                    <!-- Campo de Prioridade -->
                    <div class="mb-4">
                        <label for="taskPriority" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Prioridade</label>
                        <select id="taskPriority" class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light">
                            <option value="Baixa">Baixa</option>
                            <option value="Média" selected>Média</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label for="taskProject" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Projeto</label>
                            <input type="text" id="taskProject" class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light" placeholder="Selecione ou crie um novo" autocomplete="off">
                            <div id="project-suggestions" class="absolute z-10 w-full bg-white dark:bg-custom-darkest border border-custom-medium dark:border-custom-dark rounded-md mt-1 hidden shadow-lg max-h-40 overflow-y-auto"></div>
                        </div>
                        <div class="relative">
                            <div class="flex justify-between items-center mb-2">
                                <label for="color-picker-button" class="block text-sm font-bold text-custom-dark dark:text-custom-medium">Cor</label>
                                <button type="button" id="native-color-picker-trigger" title="Escolher cor específica"><i data-lucide="palette" class="w-5 h-5 text-custom-dark dark:text-custom-medium hover:text-custom-darkest dark:hover:text-white transition-colors"></i></button>
                            </div>
                            <button type="button" id="color-picker-button" class="w-full h-[46px] rounded-lg border border-custom-medium dark:border-custom-dark"></button>
                            <input type="color" id="taskProjectColor" value="#526D82" class="absolute top-0 left-0 w-0 h-0 opacity-0">
                            <div id="color-palette" class="absolute z-30 mt-1 w-full p-2 bg-white dark:bg-custom-darkest border border-custom-medium dark:border-custom-dark rounded-md shadow-lg hidden grid grid-cols-6 gap-2"></div>
                        </div>
                    </div>
                    <div>
                        <label for="taskDueDate" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Data Prevista (Opcional)</label>
                        <input type="date" id="taskDueDate" class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light">
                    </div>
                    <div>
                        <label for="taskAzureLink" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Link Azure DevOps (Opcional)</label>
                        <input type="url" id="taskAzureLink" placeholder="https://dev.azure.com/..." class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light">
                    </div>
                </div>
                <div class="p-4 bg-custom-light/50 dark:bg-custom-dark/20 flex items-center justify-end gap-4">
                    <button type="button" id="cancelBtn" class="bg-custom-medium hover:bg-custom-dark text-custom-darkest hover:text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="bg-custom-dark hover:bg-custom-darkest text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Histórico da Tarefa -->
    <div id="taskHistoryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <!-- NOVO LAYOUT DO MODAL -->
        <div class="bg-custom-light dark:bg-custom-darkest border border-custom-medium/50 dark:border-custom-dark/50 rounded-xl shadow-2xl p-6 w-full max-w-4xl mx-4 flex flex-col max-h-[90vh]">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-custom-medium/30 dark:border-custom-dark/50">
                <div>
                    <h2 id="modal-info-title" class="text-2xl font-bold text-custom-darkest dark:text-custom-light"></h2>
                    <p id="modal-info-project" class="text-sm font-semibold"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="editTaskBtn" class="p-2 rounded-full text-custom-darkest dark:text-custom-light hover:bg-custom-medium/50 dark:hover:bg-custom-dark/50" title="Editar Tarefa">
                        <i data-lucide="file-pen-line" class="w-6 h-6 pointer-events-none"></i>
                    </button>
                    <button id="closeHistoryBtn" class="p-2 rounded-full text-custom-darkest dark:text-custom-light hover:bg-custom-medium/50 dark:hover:bg-custom-dark/50">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Corpo do Modal com Duas Colunas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 overflow-y-auto">
                <!-- Coluna da Esquerda: Detalhes -->
                <div class="md:col-span-2 space-y-4">
                    <div>
                        <h3 class="font-bold text-sm text-custom-dark dark:text-custom-medium mb-1">Descrição</h3>
                        <p id="modal-info-description" class="text-custom-darkest dark:text-custom-light whitespace-pre-wrap"></p>
                    </div>
                    <div class="border-t border-custom-medium/30 dark:border-custom-dark/50 pt-4">
                        <h3 class="font-bold text-sm text-custom-dark dark:text-custom-medium mb-1">Responsáveis</h3>
                        <p id="modal-info-responsible" class="text-custom-darkest dark:text-custom-light"></p>
                    </div>
                    <div id="modal-info-dueDate-container" class="hidden border-t border-custom-medium/30 dark:border-custom-dark/50 pt-4">
                        <h3 class="font-bold text-sm text-custom-dark dark:text-custom-medium mb-1">Data Prevista</h3>
                        <p id="modal-info-dueDate" class="text-custom-darkest dark:text-custom-light"></p>
                    </div>
                    <div id="modal-info-azure-link-container" class="hidden border-t border-custom-medium/30 dark:border-custom-dark/50 pt-4">
                        <h3 class="font-bold text-sm text-custom-dark dark:text-custom-medium mb-1">Link Azure DevOps</h3>
                        <a id="modal-info-azure-link" href="#" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline break-all"></a>
                    </div>
                </div>

                <!-- Coluna da Direita: Atividade e Comentários -->
                <div class="md:col-span-1 border-l border-custom-medium/30 dark:border-custom-dark/50 pl-6 flex flex-col">
                    <h3 class="font-bold text-sm text-custom-dark dark:text-custom-medium mb-2">Atividade</h3>
                    <div id="activity-feed" class="space-y-3 flex-grow overflow-y-auto pr-2">
                        <!-- O histórico e os comentários serão inseridos aqui -->
                    </div>
                    <div class="mt-4 pt-4 border-t border-custom-medium/30 dark:border-custom-dark/50">
                        <h3 class="font-bold text-sm text-custom-dark dark:text-custom-medium mb-2">Adicionar Comentário</h3>
                        <textarea id="comment-input" class="w-full shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg py-2 px-3 text-custom-darkest dark:text-custom-light" placeholder="Escreva um comentário..." rows="2"></textarea>
                        <div class="flex justify-end mt-2">
                            <button id="add-comment-btn" class="bg-custom-dark hover:bg-custom-darkest text-white font-bold p-2 rounded-lg transition-colors flex items-center gap-2">
                                <i data-lucide="send" class="w-5 h-5"></i>
                                <span>Enviar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Confirmação de Exclusão -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-custom-light dark:bg-custom-darkest border border-custom-medium/50 dark:border-custom-dark/50 rounded-xl shadow-2xl p-8 w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold text-red-600 dark:text-red-500 mb-4 flex items-center gap-2">
                <i data-lucide="trash-2" class="w-6 h-6"></i>
                Confirmar Exclusão
            </h2>
            <p class="text-custom-darkest dark:text-custom-light mb-6">Você tem certeza que deseja excluir esta tarefa? Esta ação não pode ser desfeita.</p>
            <div class="flex items-center justify-end gap-4 mt-8">
                <button type="button" id="cancelDeleteBtn" class="bg-custom-medium hover:bg-custom-dark text-custom-darkest hover:text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Excluir</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal para Definir Data Prevista -->
    <div id="dueDateModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-custom-light dark:bg-custom-darkest border border-custom-medium/50 dark:border-custom-dark/50 rounded-xl shadow-2xl p-8 w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold text-custom-darkest dark:text-custom-light mb-4 flex items-center gap-2">
                <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                Definir Data Prevista
            </h2>
            <p class="text-custom-darkest dark:text-custom-light mb-6">Esta tarefa precisa de uma data de previsão para avançar. Por favor, defina um prazo.</p>
            <form id="dueDateForm">
                <div class="mb-4">
                    <label for="modalDueDate" class="block text-sm font-bold mb-2 text-custom-dark dark:text-custom-medium">Data Prevista</label>
                    <input type="date" id="modalDueDate" class="shadow-sm appearance-none border border-custom-medium dark:border-custom-dark bg-white/50 dark:bg-custom-dark/50 rounded-lg w-full py-3 px-4 text-custom-darkest dark:text-custom-light" required>
                </div>
                <div class="flex items-center justify-end gap-4 mt-8">
                    <button type="button" id="cancelDueDateBtn" class="bg-custom-medium hover:bg-custom-dark text-custom-darkest hover:text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="bg-custom-dark hover:bg-custom-darkest text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar Data</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO DA APLICAÇÃO ---
            let tasks = []; // A lista de tarefas agora começa vazia
            let isRendering = false;
            let taskToHighlightTemporarily = null;
            let selectedProject = 'all';
            let selectedResponsible = 'all';
            let sortColumn = 'createdAt';
            let sortDirection = 'desc';
            let currentView = 'list';
            let lastInteractedTaskId = null;
            let taskIdToDelete = null;
            let editingTaskId = null;
            let taskBeingMoved = null;

            // --- FUNÇÃO PARA BUSCAR DADOS DA API ---
            async function fetchAndRenderTasks() {
                // Se já estiver a renderizar, não faz nada para evitar sobreposições
                if (isRendering) return; 
                isRendering = true;

                try {
                    // Cria duas "promessas" que irão correr em paralelo:
                    // 1. A busca dos dados da API.
                    const fetchData = fetch('/api/getTasks').then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    });

                    // 2. Um temporizador que garante uma espera mínima de 5 segundos.
                    const minDisplayTime = new Promise(resolve => setTimeout(resolve, 5000));

                    // Espera que AMBAS as promessas estejam concluídas.
                    const [fetchedTasks] = await Promise.all([fetchData, minDisplayTime]);

                    tasks = fetchedTasks;

                    // Esconde o loader e mostra o conteúdo principal
                    loaderContainerEl.classList.add('hidden');
                    mainContentEl.classList.add('content-reveal');
                    updateActiveView(); 
                    renderArchivedTasks();

                    lucide.createIcons(); 

                } catch (error) { // CORREÇÃO: Adicionadas as chavetas {} em volta do bloco catch
                    console.error("Falha ao buscar tarefas:", error);
                    loaderContainerEl.innerHTML = '<p class="text-red-500">Falha ao carregar as tarefas.</p>';
                } finally {
                    isRendering = false;
                }
            }

            function connectToSignalR() {
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl('/api') // A SWA CLI/Azure irá encaminhar isto para a função 'negotiate'
                    .build();

            connection.on('tasksUpdated', () => {
                console.log('Notificação recebida: atualizando tarefas.');
                const persistentHighlightId = lastInteractedTaskId;
                // Verifica se o modal de informações está visível ANTES de buscar os novos dados
                const isHistoryModalOpen = !document.getElementById('taskHistoryModal').classList.contains('hidden');

                fetchAndRenderTasks().then(() => {
                    // Após a UI principal ser redesenhada...

                    // Se o modal estava aberto, redesenha o seu conteúdo com os dados atualizados
                    if (isHistoryModalOpen && persistentHighlightId) {
                        renderTaskHistory(persistentHighlightId);
                    }

                    // A lógica de destaque continua a funcionar como antes
                    if (persistentHighlightId && currentView === 'list') {
                        lastInteractedTaskId = persistentHighlightId;
                        highlightTask(persistentHighlightId, false);
                    }
                    if (taskToHighlightTemporarily) {
                        highlightTask(taskToHighlightTemporarily, true);
                        taskToHighlightTemporarily = null;
                    }
                });
            });

                // Tenta reconectar-se automaticamente em caso de perda de conexão
                async function start() {
                    try {
                        await connection.start();
                        console.log("Conectado ao SignalR.");
                    } catch (err) {
                        console.log(err);
                        setTimeout(start, 5000);
                    }
                };

                connection.onclose(async () => {
                    await start();
                });

                start();
            }

            // NOVA FUNÇÃO PARA SUGESTÕES DE RESPONSÁVEIS (COM MULTI-SELEÇÃO)
            const setupTagInput = (initialResponsibles = []) => {
                const container = document.getElementById('responsible-input-container');
                const input = document.getElementById('taskResponsible');
                const suggestionsContainer = document.getElementById('responsible-suggestions');
                const allResponsibles = [...new Set(tasks.flatMap(t => t.responsible).filter(Boolean))];
                let currentResponsibles = [...initialResponsibles];

                const renderTags = () => {
                    // Remove as tags antigas para evitar duplicação
                    container.querySelectorAll('.responsible-tag').forEach(tag => tag.remove());
                    // Adiciona as tags atualizadas
                    currentResponsibles.forEach(name => {
                        const tag = document.createElement('div');
                        tag.className = 'responsible-tag';

                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = name;
                        tag.appendChild(nameSpan);

                        const removeBtn = document.createElement('span');
                        removeBtn.className = 'tag-remove-btn';
                        removeBtn.innerHTML = `<i data-lucide="x" class="w-3 h-3 pointer-events-none"></i>`;
                        removeBtn.onclick = () => {
                            currentResponsibles = currentResponsibles.filter(r => r !== name);
                            renderTags();
                        };

                        tag.appendChild(removeBtn);
                        container.insertBefore(tag, input);
                    });
                    lucide.createIcons();
                };

                const addResponsible = (name) => {
                    const trimmedName = name.trim();
                    if (trimmedName && !currentResponsibles.includes(trimmedName)) {
                        currentResponsibles.push(trimmedName);
                        renderTags();
                    }
                    input.value = '';
                    suggestionsContainer.classList.add('hidden');
                };

                input.addEventListener('keydown', (e) => {
                    if (e.key === ',' || e.key === 'Enter') {
                        e.preventDefault();
                        addResponsible(input.value);
                    }
                    if (e.key === 'Backspace' && input.value === '' && currentResponsibles.length > 0) {
                        currentResponsibles.pop();
                        renderTags();
                    }
                });

                const showSuggestions = (filteredData) => {
                    suggestionsContainer.innerHTML = '';
                    if (filteredData.length === 0) {
                        suggestionsContainer.classList.add('hidden');
                        return;
                    }
                    filteredData.forEach(name => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'p-2 cursor-pointer hover:bg-custom-light dark:hover:bg-custom-dark';
                        suggestionItem.textContent = name;
                        suggestionItem.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            addResponsible(name);
                            input.focus();
                        });
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                    suggestionsContainer.classList.remove('hidden');
                };

                const updateSuggestions = () => {
                    const query = input.value.trim().toLowerCase();
                    const availableSuggestions = allResponsibles.filter(name => !currentResponsibles.includes(name));
                    if (query === '') {
                        showSuggestions(availableSuggestions);
                    } else {
                        const filtered = availableSuggestions.filter(name => name.toLowerCase().includes(query));
                        showSuggestions(filtered);
                    }
                };

                input.addEventListener('focus', updateSuggestions);
                input.addEventListener('input', updateSuggestions);

                renderTags(); // Renderiza as tags iniciais
            };

            // NOVA FUNÇÃO PARA SUGESTÕES DE PROJETOS
            const setupProjectSuggestions = () => {
                const input = document.getElementById('taskProject');
                const suggestionsContainer = document.getElementById('project-suggestions');
                const colorInput = document.getElementById('taskProjectColor');
                const projects = new Map();
                tasks.forEach(task => {
                    if (task.project && !projects.has(task.project)) {
                        projects.set(task.project, task.projectColor);
                    }
                });
                const allProjects = Array.from(projects.keys());

                const showSuggestions = (filteredData) => {
                    suggestionsContainer.innerHTML = '';
                    if (filteredData.length === 0) {
                        suggestionsContainer.classList.add('hidden');
                        return;
                    }

                    filteredData.forEach(name => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'p-2 cursor-pointer hover:bg-custom-light dark:hover:bg-custom-dark';
                        suggestionItem.textContent = name;
                        suggestionItem.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            input.value = name;
                            colorInput.value = projects.get(name);
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                    suggestionsContainer.classList.remove('hidden');
                };

                const updateSuggestions = () => {
                    const query = input.value.toLowerCase();
                    const filtered = allProjects.filter(name => name.toLowerCase().includes(query));
                    showSuggestions(filtered);
                };

                input.addEventListener('focus', updateSuggestions);
                input.addEventListener('input', updateSuggestions);
            };

            // --- ELEMENTOS DOM ---
            const responsibleFilterEl = document.getElementById('responsibleFilter');
            const kanbanViewEl = document.getElementById('kanbanView');
            const mainContentEl = document.getElementById('main-content');
            mainContentEl.classList.add('content-hidden');
            const listViewEl = document.getElementById('listView');
            const archivedViewEl = document.getElementById('archivedView');
            const viewSwitcherEl = document.getElementById('view-switcher');
            const loaderContainerEl = document.getElementById('loader-container');
            const projectFilterEl = document.getElementById('projectFilter');
            const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const dueDateModalEl = document.getElementById('dueDateModal');
            const dueDateForm = document.getElementById('dueDateForm');
            const cancelDueDateBtn = document.getElementById('cancelDueDateBtn');
            const statusLabels = { todo: 'A fazer', stopped: 'Parado', inprogress: 'Em Andamento', homologation: 'Em Homologação', done: 'Pronto', edited: 'Editado' };

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                // A opção timeZone: 'UTC' diz ao formatador para ignorar o fuso horário local
                // e formatar a data tal como ela está (ex: 2025-08-10T00:00:00Z será sempre 10/08/2025).
                return date.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    timeZone: 'UTC' 
                });
            };
            const formatDateTime = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };
            const getSortIndicator = (columnName) => {
                if (sortColumn !== columnName) return '';
                const icon = sortDirection === 'asc' ? 'arrow-up' : 'arrow-down';
                return `<i data-lucide="${icon}" class="w-4 h-4 ml-1"></i>`;
            };

            const createTaskElement = (task) => {
                const taskCard = document.createElement('div');

                // LÓGICA DE TAREFA ATRASADA
                const overdueClass = isTaskOverdue(task) ? ' task-overdue' : '';
                taskCard.className = `task-card bg-white dark:bg-custom-darkest rounded-lg border border-custom-medium/50 dark:border-custom-dark cursor-grab flex flex-col overflow-hidden${overdueClass}`;
                taskCard.dataset.taskId = task.id;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-4 relative';

                let approveButton = '';
                if (task.status === 'homologation') {
                    approveButton = `<button class="approve-btn absolute top-4 right-4 bg-yellow-500/20 hover:bg-yellow-500/40 text-yellow-700 dark:text-yellow-400 p-1.5 rounded-full" data-task-id="${task.id}" title="Aprovar e Arquivar"><i data-lucide="check-circle-2" class="w-5 h-5 pointer-events-none"></i></button>`;
                }

                let azureLinkIcon = '';
                if (task.azureLink) {
                    azureLinkIcon = `<a href="${task.azureLink}" target="_blank" rel="noopener noreferrer" class="azure-link-btn text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 p-1" title="Abrir no Azure DevOps"><i data-lucide="external-link" class="w-4 h-4 pointer-events-none"></i></a>`;
                }

                let responsibleDisplay = '';
                if (Array.isArray(task.responsible) && task.responsible.length > 0) {
                    const primaryResponsible = task.responsible[0];
                    const otherResponsiblesCount = task.responsible.length - 1;
                    responsibleDisplay = `<strong class="text-xs font-medium text-custom-dark dark:text-custom-medium">${primaryResponsible}</strong>`;
                    if (otherResponsiblesCount > 0) {
                        responsibleDisplay += `<span class="ml-1 text-xs font-bold bg-custom-medium text-custom-darkest rounded-full px-1.5 py-0.5" title="${task.responsible.slice(1).join(', ')}">+${otherResponsiblesCount}</span>`;
                    }
                } else {
                    responsibleDisplay = `<strong class="text-xs font-medium text-custom-dark dark:text-custom-medium">${task.responsible || 'N/D'}</strong>`;
                }

                let dueDateDisplay = '';
                if (task.dueDate) {
                    dueDateDisplay = `
                        <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
                            <i data-lucide="calendar" class="w-3 h-3"></i>
                            <span>${formatDate(task.dueDate)}</span>
                        </div>
                    `;
                }

                contentDiv.innerHTML = `
                    <!-- ALTERAÇÃO: Título sem negrito. A descrição completa está agora no 'title' para ser vista ao passar o rato. -->
                    <p class="text-custom-darkest dark:text-custom-light pr-8" title="${task.description}">${task.title || ''}</p>

                    ${approveButton}

                    <div class="mt-3 pt-2 border-t border-custom-medium/50 dark:border-custom-dark flex justify-between items-center">
                        <div class="flex items-center gap-1">
                            <button class="info-btn text-custom-medium hover:text-custom-dark dark:hover:text-custom-light p-1" data-task-id="${task.id}" title="Ver histórico"><i data-lucide="info" class="w-4 h-4 pointer-events-none"></i></button>
                            ${azureLinkIcon}
                            <button class="delete-btn text-red-400 hover:text-red-600 dark:hover:text-red-500 p-1" data-task-id="${task.id}" title="Excluir tarefa"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                            ${dueDateDisplay}
                            ${responsibleDisplay}
                        </div>
                    </div>
                `;

                taskCard.appendChild(contentDiv);

                if (task.project) {
                    const projectBar = document.createElement('div');
                    projectBar.className = 'text-xs text-white px-4 py-0.5 mt-auto';
                    projectBar.style.backgroundColor = task.projectColor;
                    projectBar.textContent = task.project;
                    taskCard.appendChild(projectBar);
                }

                return taskCard;
            };
                        
            const renderKanbanView = () => {
                document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
                
                let activeTasks = tasks.filter(t => t.status !== 'done');
                if (selectedResponsible !== 'all') {
                    activeTasks = activeTasks.filter(t => Array.isArray(t.responsible) && t.responsible.includes(selectedResponsible));
                }
                if (selectedProject !== 'all') {
                    activeTasks = activeTasks.filter(t => t.project === selectedProject);
                }

                const columns = [
                    { id: 'todo', name: 'A fazer' },
                    { id: 'stopped', name: 'Parado' },
                    { id: 'inprogress', name: 'Em Andamento' },
                    { id: 'homologation', name: 'Em Homologação' },
                ];

                columns.forEach(col => {
                    const columnEl = kanbanViewEl.querySelector(`.kanban-column:has([data-column-id="${col.id}"])`);
                    if (columnEl) {
                        const tasksForColumn = activeTasks.filter(t => t.status === col.id)
                        .sort((a, b) => a.order - b.order); // Pra garantir que as tarefas vão ser renderizadas na ordem certa
                        const header = columnEl.querySelector('h2');
                        const list = columnEl.querySelector('.task-list');
                        
                        header.className = 'font-bold text-lg mb-4 text-custom-darkest dark:text-custom-light flex justify-between items-center';
                        header.innerHTML = `
                            <span>${col.name}</span>
                            <span class="bg-custom-medium/50 dark:bg-custom-dark/80 text-custom-darkest dark:text-custom-light text-xs font-bold px-2 py-1 rounded-full">${tasksForColumn.length}</span>
                        `;
                        
                        tasksForColumn.forEach(task => {
                            list.appendChild(createTaskElement(task));
                        });
                    }
                });
                
                lucide.createIcons();
            };

            const renderListView = () => {
                let activeTasks = tasks.filter(t => t.status !== 'done');
                if (selectedResponsible !== 'all') {
                    activeTasks = activeTasks.filter(t => Array.isArray(t.responsible) && t.responsible.includes(selectedResponsible));
                }
                if (selectedProject !== 'all') {
                    activeTasks = activeTasks.filter(t => t.project === selectedProject);
                }

                activeTasks.sort((a, b) => {
                    const valA = (sortColumn === 'responsible' ? a.responsible?.[0] : a[sortColumn]) || '';
                    const valB = (sortColumn === 'responsible' ? b.responsible?.[0] : b[sortColumn]) || '';

                    if (sortColumn === 'createdAt' || sortColumn === 'dueDate') { // Adicionada a verificação para dueDate
                        // Trata as datas nulas para que fiquem no final
                        if (!valA) return 1;
                        if (!valB) return -1;
                        return sortDirection === 'asc' 
                            ? new Date(valA) - new Date(valB) 
                            : new Date(valB) - new Date(valA);
                    }

                    return sortDirection === 'asc' 
                        ? String(valA).trim().toLowerCase().localeCompare(String(valB).trim().toLowerCase()) 
                        : String(valB).trim().toLowerCase().localeCompare(String(valA).trim().toLowerCase());
                });

                const tableBody = activeTasks.map(task => {
                    let azureLinkIcon = task.azureLink 
                        ? `<a href="${task.azureLink}" target="_blank" rel="noopener noreferrer" class="azure-link-btn text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 p-1" title="Abrir no Azure DevOps"><i data-lucide="external-link" class="w-5 h-5 pointer-events-none"></i></a>`
                        : `<div class="w-7 h-7"></div>`;

                    let projectTag = '';
                    if (task.project) {
                        projectTag = `<span class="text-xs font-bold rounded px-2 py-1" style="background-color:${task.projectColor}; color: #fff;">${task.project}</span>`;
                    }

                    return `
                        <tr class="list-row hover:bg-custom-light/50 dark:hover:bg-custom-dark/50" data-task-id="${task.id}">
                            <td class="px-6 py-4 font-mono text-xs text-white-500" title="${task.id}">${task.id}</td>
                            <td class="px-6 py-4">
                                <div><div class="text-custom-darkest dark:text-custom-light" title="${task.description}">${task.title}</div></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">${projectTag}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${Array.isArray(task.responsible) ? task.responsible.join(', ') : task.responsible}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${statusLabels[task.status] || task.status}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(task.createdAt)}</td>
                            <!-- NOVA CÉLULA PARA A DATA PREVISTA -->
                            <td class="px-6 py-4 whitespace-nowrap">${task.dueDate ? formatDate(task.dueDate) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <button class="info-btn text-custom-medium hover:text-custom-dark dark:hover:text-custom-light p-1" data-task-id="${task.id}" title="Ver histórico"><i data-lucide="info" class="w-5 h-5 pointer-events-none"></i></button>
                                    ${azureLinkIcon}
                                    <button class="delete-btn text-red-400 hover:text-red-600 dark:hover:text-red-500 p-1" data-task-id="${task.id}" title="Excluir tarefa"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                const tableHtml = `
                    <div class="bg-white dark:bg-custom-darkest/40 rounded-lg shadow overflow-hidden">
                        <table class="min-w-full">
                            <thead class="bg-custom-light dark:bg-custom-darkest/60">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="id">
                                        <div class="flex items-center">ID ${getSortIndicator('id')}</div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="title">
                                        <div class="flex items-center gap-2">
                                            <span>Tarefa</span>
                                            <span class="bg-custom-medium/50 dark:bg-custom-dark/80 text-custom-darkest dark:text-custom-light text-xs font-bold px-2 py-1 rounded-full">${activeTasks.length}</span>
                                            ${getSortIndicator('title')}
                                        </div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="project">
                                        <div class="flex items-center">Projeto ${getSortIndicator('project')}</div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="responsible">
                                        <div class="flex items-center">Responsável ${getSortIndicator('responsible')}</div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="status">
                                        <div class="flex items-center">Estado ${getSortIndicator('status')}</div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="createdAt">
                                        <div class="flex items-center">Criação ${getSortIndicator('createdAt')}</div>
                                    </th>
                                    <!-- NOVO CABEÇALHO DE COLUNA -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider cursor-pointer sortable-header" data-sort-by="dueDate">
                                        <div class="flex items-center">Data Prevista ${getSortIndicator('dueDate')}</div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="list-view-tbody" class="divide-y divide-custom-light dark:divide-custom-dark">
                                ${tableBody}
                                ${activeTasks.length === 0 ? '<tr><td colspan="8" class="text-center py-10 text-custom-dark dark:text-custom-medium">Nenhuma tarefa encontrada.</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                `;

                listViewEl.innerHTML = tableHtml;
                lucide.createIcons();
            };

            const updateActiveView = () => {
                populateResponsibleFilter();
                populateProjectFilter();
                
                // Este bloco atualiza a aparência dos botões de vista (Lista/Kanban/Arquivados)
                viewSwitcherEl.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.toggle('bg-custom-light', btn.dataset.view === currentView);
                    btn.classList.toggle('text-custom-darkest', btn.dataset.view === currentView);
                    btn.classList.toggle('text-custom-light', btn.dataset.view !== currentView);
                });

                // Este bloco controla qual das três vistas (Kanban, Lista, ou Arquivados) é exibida
                kanbanViewEl.classList.toggle('hidden', currentView !== 'kanban');
                listViewEl.classList.toggle('hidden', currentView !== 'list');
                archivedViewEl.classList.toggle('hidden', currentView !== 'archived'); // <-- NOVO

                // Este bloco decide qual função de renderização chamar com base na vista ativa
                if (currentView === 'kanban') {
                    renderKanbanView();
                } else if (currentView === 'list') {
                    renderListView();
                } else if (currentView === 'archived') {
                    renderArchivedTasks(); // <-- NOVO
                }

                // Esta parte, que você já tinha, continua a ser importante para o destaque visual
                if (lastInteractedTaskId) {
                    setTimeout(() => {
                        highlightTask(lastInteractedTaskId, currentView === 'kanban');
                    }, 0);
                }
            };

            listViewEl.addEventListener('click', (e) => {
                const header = e.target.closest('.sortable-header');
                if (!header) return;

                const sortBy = header.dataset.sortBy;

                // Se já estamos a ordenar por esta coluna, inverte a direção
                if (sortColumn === sortBy) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } 
                // Se for uma nova coluna, começa com a ordem ascendente
                else {
                    sortColumn = sortBy;
                    sortDirection = 'asc';
                }

                // Redesenha a vista em lista com a nova ordenação
                renderListView();
            });

            const populateProjectFilter = () => {
                const projects = [...new Set(tasks.map(t => t.project).filter(Boolean))]; // Filtra valores vazios
                const currentFilterValue = projectFilterEl.value;
                projectFilterEl.innerHTML = '<option value="all">Todos os Projetos</option>';
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    projectFilterEl.appendChild(option);
                });
                projectFilterEl.value = currentFilterValue;
            };

            const setupCustomColorPicker = () => {
                const colorInput = document.getElementById('taskProjectColor');
                const colorButton = document.getElementById('color-picker-button');
                const colorPalette = document.getElementById('color-palette');
                const nativePickerTrigger = document.getElementById('native-color-picker-trigger'); // Novo elemento

                const colors = [
                    '#526D82', '#9DB2BF', '#27374D', '#1D5B79', '#468B97', '#EF6262',
                    '#F3AA60', '#F9D949', '#68B984', '#3D5656', '#A25B5B', '#635985'
                ];

                colorPalette.innerHTML = colors.map(color => 
                    `<div class="w-full h-8 rounded-md cursor-pointer color-swatch" style="background-color: ${color};" data-color="${color}"></div>`
                ).join('');

                const syncColor = () => {
                    colorButton.style.backgroundColor = colorInput.value;
                };

                colorButton.addEventListener('click', () => {
                    colorPalette.classList.toggle('hidden');
                });

                colorPalette.addEventListener('click', (e) => {
                    const swatch = e.target.closest('.color-swatch');
                    if (swatch) {
                        colorInput.value = swatch.dataset.color;
                        syncColor();
                        colorPalette.classList.add('hidden');
                    }
                });

                // Aciona o seletor de cores nativo do navegador
                nativePickerTrigger.addEventListener('click', () => {
                    colorInput.click();
                });

                // Atualiza a cor do botão quando uma cor é escolhida no seletor nativo
                colorInput.addEventListener('input', () => {
                    syncColor();
                });

                syncColor();
            };
                        
            const renderArchivedTasks = () => {
                const archivedTasks = tasks.filter(t => t.status === 'done');

                const tableBody = archivedTasks.map(task => {
                    return `
                        <tr class="list-row hover:bg-custom-light/50 dark:hover:bg-custom-dark/50" data-task-id="${task.id}">
                            <td class="px-6 py-4"><div class="description-truncate" title="${task.description}">${task.description}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap">${task.project || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${Array.isArray(task.responsible) ? task.responsible.join(', ') : task.responsible}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(task.createdAt)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <button class="restore-btn text-blue-400 hover:text-blue-600 p-1" data-task-id="${task.id}" title="Restaurar Tarefa"><i data-lucide="undo-2" class="w-5 h-5 pointer-events-none"></i></button>
                                    <button class="delete-btn text-red-400 hover:text-red-600 p-1" data-task-id="${task.id}" title="Excluir Tarefa"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                const tableHtml = `
                    <div class="bg-white dark:bg-custom-darkest/40 rounded-lg shadow overflow-hidden">
                        <table class="min-w-full">
                            <thead class="bg-custom-light dark:bg-custom-darkest/60">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider">
                                        <div class="flex items-center gap-2">
                                            <span>Tarefa Concluída</span>
                                            <span class="bg-custom-medium/50 dark:bg-custom-dark/80 text-custom-darkest dark:text-custom-light text-xs font-bold px-2 py-1 rounded-full">${archivedTasks.length}</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider">Projeto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider">Responsável</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider">Criação</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-custom-dark dark:text-custom-light uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-custom-light dark:divide-custom-dark">
                                ${tableBody}
                                ${archivedTasks.length === 0 ? '<tr><td colspan="5" class="text-center py-10 text-custom-dark dark:text-custom-medium">Nenhuma tarefa arquivada.</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                `;

                archivedViewEl.innerHTML = tableHtml;
                lucide.createIcons();
            };

            const renderTaskHistory = (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                // Preenche os detalhes na coluna da esquerda
                document.getElementById('modal-info-title').textContent = task.title || '';
                const projectTag = document.getElementById('modal-info-project');
                if (task.project) {
                    projectTag.textContent = task.project;
                    projectTag.style.color = task.projectColor;
                } else {
                    projectTag.textContent = '';
                }
                document.getElementById('modal-info-description').textContent = task.description;
                document.getElementById('modal-info-responsible').textContent = Array.isArray(task.responsible) ? task.responsible.join(', ') : task.responsible;

                const linkContainer = document.getElementById('modal-info-azure-link-container');
                const linkEl = document.getElementById('modal-info-azure-link');
                if (task.azureLink) {
                    linkEl.href = task.azureLink;
                    linkEl.textContent = task.azureLink;
                    linkContainer.classList.remove('hidden');
                } else {
                    linkContainer.classList.add('hidden');
                }

                const dueDateContainer = document.getElementById('modal-info-dueDate-container');
                const dueDateEl = document.getElementById('modal-info-dueDate');
                if (task.dueDate) {
                    dueDateEl.textContent = formatDate(task.dueDate);
                    dueDateContainer.classList.remove('hidden');
                } else {
                    dueDateContainer.classList.add('hidden');
                }

                // Combina histórico e comentários num único feed de atividade
                const historyItems = (task.history || []).map(item => ({ ...item, type: 'history' }));
                const commentItems = (task.comments || []).map((item, index) => ({ ...item, type: 'comment', index }));
                const activityFeedItems = [...historyItems, ...commentItems].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                const feedEl = document.getElementById('activity-feed');
                feedEl.innerHTML = activityFeedItems.map(item => {
                    if (item.type === 'history') {
                        return `
                            <div class="flex items-center gap-2 text-xs">
                                <i data-lucide="history" class="w-4 h-4 text-custom-medium"></i>
                                <div>
                                    <span class="font-semibold">${statusLabels[item.status] || item.status}</span>
                                    <span class="text-custom-dark dark:text-custom-medium ml-1">${formatDateTime(item.timestamp)}</span>
                                </div>
                            </div>
                        `;
                    } else { // type === 'comment'
                        return `
                            <div class="p-2 bg-custom-light dark:bg-custom-dark/50 rounded-lg group relative">
                                <div class="flex justify-between items-center text-xs mb-1">
                                    <span class="font-bold text-custom-darkest dark:text-custom-light">${item.author || 'Usuário'}</span>
                                    <span class="text-custom-dark dark:text-custom-medium">${formatDateTime(item.timestamp)}</span>
                                </div>
                                <p class="text-sm text-custom-darkest dark:text-custom-light pr-6">${item.text}</p>
                                <button class="delete-comment-btn absolute top-1 right-1 p-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-task-id="${taskId}" data-comment-index="${item.index}" title="Excluir comentário">
                                    <i data-lucide="trash-2" class="w-3 h-3 pointer-events-none"></i>
                                </button>
                            </div>
                        `;
                    }
                }).join('');

                document.getElementById('taskHistoryModal').classList.remove('hidden');
                lucide.createIcons();
            };

            const populateResponsibleFilter = () => {
                // Usa flatMap para achatar todos os arrays de responsáveis num único array
                const responsibles = [...new Set(tasks.flatMap(t => t.responsible).filter(Boolean))];
                const currentFilterValue = responsibleFilterEl.value;
                responsibleFilterEl.innerHTML = '<option value="all">Todos</option>';
                responsibles.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r;
                    option.textContent = r;
                    responsibleFilterEl.appendChild(option);
                });
                responsibleFilterEl.value = currentFilterValue;
            };

            projectFilterEl.addEventListener('change', (e) => {
                selectedProject = e.target.value;
                updateActiveView();
            });

            const showToast = (message, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';

                toast.className = `toast text-white font-bold py-2 px-4 rounded-lg shadow-lg ${bgColor}`;
                toast.textContent = message;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            };


            // --- LÓGICA DO TEMA ---
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            
            const applyTheme = () => {
                if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    themeIconLight.classList.remove('hidden');
                    themeIconDark.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    themeIconLight.classList.add('hidden');
                    themeIconDark.classList.remove('hidden');
                }
            }

            themeToggle.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
                applyTheme();
            });

            // --- LÓGICA DOS MODAIS ---
            const taskModal = document.getElementById('taskModal');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const archivedTasksModal = document.getElementById('archivedTasksModal');
            const showArchivedBtn = document.getElementById('showArchivedBtn');
            const closeArchivedBtn = document.getElementById('closeArchivedBtn');
            const taskHistoryModal = document.getElementById('taskHistoryModal');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            const editTaskBtn = document.getElementById('editTaskBtn');

            const openEditModal = (taskId) => {
                const taskToEdit = tasks.find(t => t.id === taskId);
                if (!taskToEdit) return;

                editingTaskId = taskId;

                document.getElementById('modalTitle').textContent = 'Editar Tarefa';
                document.getElementById('taskTitle').value = taskToEdit.title || '';
                document.getElementById('taskDescription').value = taskToEdit.description;
                document.getElementById('taskAzureLink').value = taskToEdit.azureLink || '';
                document.getElementById('taskProject').value = taskToEdit.project || '';
                document.getElementById('taskProjectColor').value = taskToEdit.projectColor || '#526D82';
                document.getElementById('color-picker-button').style.backgroundColor = taskToEdit.projectColor || '#526D82';
                document.getElementById('taskDueDate').value = taskToEdit.dueDate ? taskToEdit.dueDate.split('T')[0] : '';
                document.getElementById('taskPriority').value = taskToEdit.priority || 'Média';

                setupTagInput(taskToEdit.responsible || []);
                setupProjectSuggestions();
                taskHistoryModal.classList.add('hidden');
                taskModal.classList.remove('hidden');
            };

            addTaskBtn.addEventListener('click', () => {
                editingTaskId = null;
                document.getElementById('modalTitle').textContent = 'Nova Tarefa';
                document.getElementById('taskForm').reset();
                document.getElementById('taskProjectColor').value = '#526D82';
                document.getElementById('color-picker-button').style.backgroundColor = '#526D82';
                setupTagInput([]);
                setupProjectSuggestions();
                taskModal.classList.remove('hidden');
            });
            
            cancelBtn.addEventListener('click', () => {
                taskModal.classList.add('hidden');
                // Se estávamos a editar uma tarefa, volta para o ecrã de informações
                if (editingTaskId) {
                    renderTaskHistory(editingTaskId);
                    // Garante que o destaque persistente na lista seja mantido
                    lastInteractedTaskId = editingTaskId; 
                    highlightTask(editingTaskId, false);
                }
            });
            
            closeHistoryBtn.addEventListener('click', () => {
                taskHistoryModal.classList.add('hidden');
                // Se a vista atual for Kanban, remove o destaque persistente ao fechar.
                if (currentView === 'kanban') {
                    highlightTask(null); // Remove qualquer destaque existente.
                    lastInteractedTaskId = null; // Esquece a última tarefa interagida.
                }
                // Na vista de Lista, o destaque permanece intencionalmente.
            });

            editTaskBtn.addEventListener('click', () => {
                openEditModal(lastInteractedTaskId);
            });

            document.getElementById('activity-feed').addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-comment-btn');
                if (deleteBtn) {
                    const taskId = deleteBtn.dataset.taskId;
                    const commentIndex = deleteBtn.dataset.commentIndex;

                    openDeleteModal(
                        'Excluir Comentário', 
                        'Tem a certeza de que quer excluir este comentário? Esta ação não pode ser desfeita.',
                        async () => { // Esta é a ação que será executada ao confirmar
                            try {
                                const response = await fetch(`/api/deleteComment/${taskId}`, {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ index: parseInt(commentIndex) })
                                });
                                if (!response.ok) throw new Error('Falha ao excluir o comentário.');
                                showToast('Comentário excluído com sucesso!');
                            } catch (error) {
                                console.error("Erro ao excluir comentário:", error);
                                showToast('Falha ao excluir o comentário.', 'error');
                            }
                        }
                    );
                }
            });

            document.getElementById('add-comment-btn').addEventListener('click', async () => {
                const commentInput = document.getElementById('comment-input');
                const commentText = commentInput.value.trim();
                if (!commentText || !lastInteractedTaskId) return;

                // Por agora, vamos usar um nome fixo. No futuro, isto viria da autenticação.
                const commentAuthor = "Usuário"; 

                try {
                    const response = await fetch(`/api/addComment/${lastInteractedTaskId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: commentText, author: commentAuthor })
                    });
                    if (!response.ok) throw new Error('Falha ao adicionar o comentário.');

                    commentInput.value = ''; // Limpa o campo
                    // O SignalR irá tratar de atualizar a UI
                } catch (error) {
                    console.error("Erro ao adicionar comentário:", error);
                    showToast('Falha ao adicionar o comentário.', 'error');
                }
            });

            document.getElementById('taskForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                let projectName = document.getElementById('taskProject').value.trim();
                if (projectName && !projectName.startsWith('#')) {
                    projectName = '#' + projectName;
                }

                const responsibleTags = Array.from(document.querySelectorAll('#responsible-input-container .responsible-tag'));
                const responsibleNames = responsibleTags.map(tag => tag.firstChild.textContent);

                // --- LÓGICA DA DATA CORRIGIDA ---
                const dueDateValue = document.getElementById('taskDueDate').value;
                let dueDateISO = null;
                if (dueDateValue) {
                    // Cria a data em UTC para evitar problemas de fuso horário
                    const dateParts = dueDateValue.split('-');
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1; // Mês em JS é 0-11
                    const day = parseInt(dateParts[2], 10);
                    dueDateISO = new Date(Date.UTC(year, month, day)).toISOString();
                }

                const taskPayload = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    responsible: responsibleNames.join(','),
                    azureLink: document.getElementById('taskAzureLink').value,
                    project: projectName,
                    projectColor: document.getElementById('taskProjectColor').value,
                    dueDate: dueDateISO, // Usa a nova variável
                    priority: document.getElementById('taskPriority').value
                };

                try {
                    let response;
                    if (editingTaskId) {
                        response = await fetch(`/api/updateTask/${editingTaskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(taskPayload)
                        });
                    } else {
                        response = await fetch('/api/createTask', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(taskPayload),
                        });
                    }
                    if (!response.ok) throw new Error('Falha ao salvar a tarefa.');

                    const savedTask = await response.json();
                    taskToHighlightTemporarily = savedTask.id;

                    taskModal.classList.add('hidden');
                    e.target.reset();
                    editingTaskId = null;
                } catch (error) {
                    console.error("Erro ao salvar tarefa:", error);
                }
            });

            const isTaskOverdue = (task) => {
                if (!task.dueDate || !['inprogress', 'stopped', 'homologation'].includes(task.status)) {
                    return false;
                }
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Zera a hora para comparar apenas as datas
                const dueDate = new Date(task.dueDate);
                return dueDate < today;
            };

            // --- LÓGICA DE EXCLUSÃO ---
            const openDeleteModal = (title, message, onConfirm) => {
                document.querySelector('#deleteConfirmModal h2').textContent = title;
                document.querySelector('#deleteConfirmModal p').textContent = message;

                // Guarda a ação a ser executada quando o utilizador confirmar
                confirmDeleteBtn.onclick = () => {
                    onConfirm();
                    deleteConfirmModalEl.classList.add('hidden');
                };

                deleteConfirmModalEl.classList.remove('hidden');
                lucide.createIcons();
            };

            const openDueDateModal = (task, newStatus) => {
                taskBeingMoved = { task, newStatus };
                dueDateModalEl.classList.remove('hidden');
                document.getElementById('modalDueDate').focus();
                lucide.createIcons();
            };

            // Este listener agora apenas fecha o modal no clique,
            // a ação de confirmação é gerida pelo .onclick
            cancelDeleteBtn.addEventListener('click', () => {
                deleteConfirmModalEl.classList.add('hidden');
            });

            cancelDeleteBtn.addEventListener('click', () => {
                taskIdToDelete = null;
                deleteConfirmModalEl.classList.add('hidden');
            });

            dueDateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!taskBeingMoved) return;

                const newDueDate = document.getElementById('modalDueDate').value;
                const { task, newStatus } = taskBeingMoved;

                taskToHighlightTemporarily = task.id;
                try {
                    await fetch(`/api/updateTask/${task.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus, dueDate: newDueDate })
                    });
                    showToast('Tarefa movida e data definida!');
                    dueDateModalEl.classList.add('hidden');
                    taskBeingMoved = null;
                } catch (error) {
                    console.error("Erro ao definir data e mover tarefa:", error);
                    showToast('Falha ao salvar a data.', 'error');
                }
            });

            cancelDueDateBtn.addEventListener('click', () => {
                dueDateModalEl.classList.add('hidden');
                taskBeingMoved = null;
                fetchAndRenderTasks(); // Recarrega para reverter qualquer movimento visual
            });


            // --- LÓGICA DE DRAG AND DROP E AÇÕES ---
            const highlightTask = (taskId, temporary = true) => {
                document.querySelectorAll('.highlight, .new-card').forEach(el => {
                    el.classList.remove('highlight');
                    el.classList.remove('new-card');
                });

                if (!taskId) return;
                const selector = `.task-card[data-task-id="${taskId}"], .list-row[data-task-id="${taskId}"]`;
                const elementToHighlight = document.querySelector(selector);

                if (elementToHighlight) {
                    const classToAdd = temporary ? 'new-card' : 'highlight';
                    elementToHighlight.classList.add(classToAdd);

                    // Timer para o destaque temporário
                    if (temporary) {
                        setTimeout(() => {
                            if (elementToHighlight.classList.contains('new-card')) {
                                elementToHighlight.classList.remove('new-card');
                            }
                        }, 1500); // Remove a classe após 1.5 segundos
                    }
                }
            };
            const initializeDragAndDrop = () => {
                document.querySelectorAll('.task-list').forEach(list => {
                    new Sortable(list, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        dragoverClass: 'drop-target-highlight',
                        forceFallback: true,
                        fallbackOnBody: true,
                        onEnd: async function (evt) {
                            const taskId = evt.item.dataset.taskId;
                            const newStatus = evt.to.dataset.columnId;
                            const task = tasks.find(t => t.id === taskId);

                            const activeColumns = ['stopped', 'inprogress', 'homologation'];

                            // VERIFICAÇÃO: Se a tarefa está a entrar numa coluna ativa e não tem data
                            if (activeColumns.includes(newStatus) && !task.dueDate) {
                                // Cancela o movimento visual e abre o modal
                                evt.from.appendChild(evt.item); 
                                openDueDateModal(task, newStatus);
                                return; // Para a execução aqui
                            }

                            taskToHighlightTemporarily = taskId;

                            if (task && task.status !== newStatus) {
                                try {
                                    await fetch(`/api/updateTask/${taskId}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ status: newStatus })
                                    });
                                } catch (error) { console.error("Erro ao mover tarefa:", error); }
                            } else {
                                try {
                                    const allTaskElements = Array.from(document.querySelectorAll('.task-card'));
                                    const orderedTasksPayload = allTaskElements.map((el, index) => ({
                                        id: el.dataset.taskId,
                                        order: index
                                    }));
                                    await fetch(`/api/updateOrder`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(orderedTasksPayload)
                                    });
                                } catch (error) { console.error("Erro ao reordenar tarefas:", error); }
                            }
                        }
                    });
                });
            };
            
            // Event listener unificado para ações
            document.body.addEventListener('click', async (e) => {
                const targetButton = e.target.closest('button, a');
                if (!targetButton || targetButton.classList.contains('azure-link-btn')) return;

                const taskId = targetButton.dataset.taskId || null;
                if (!taskId) return;

                // Ação de Aprovar/Arquivar Tarefa
                if (targetButton.classList.contains('approve-btn')) {
                    try {
                        await fetch(`/api/updateTask/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'done' })
                        });
                        showToast('Tarefa arquivada!');
                    } catch (error) { 
                        console.error("Erro ao arquivar tarefa:", error);
                        showToast('Falha ao arquivar a tarefa.', 'error');
                    }
                } 
                // Ação de Ver Informações
                else if (targetButton.classList.contains('info-btn')) {
                    lastInteractedTaskId = taskId;
                    highlightTask(taskId, false);
                    renderTaskHistory(taskId);
                } 
                // Ação de Excluir
                else if (targetButton.classList.contains('delete-btn')) {
                    openDeleteModal(
                        'Excluir Tarefa',
                        'Tem a certeza de que quer excluir esta tarefa? Esta ação não pode ser desfeita.',
                        async () => {
                            try {
                                const response = await fetch(`/api/deleteTask/${taskId}`, { method: 'DELETE' });
                                if (!response.ok) throw new Error('Falha ao excluir a tarefa.');
                                showToast('Tarefa excluída com sucesso!');
                            } catch (error) {
                                console.error("Erro ao excluir tarefa:", error);
                                showToast('Falha ao excluir a tarefa.', 'error');
                            }
                        }
                    );
                }
                // Ação de Restaurar Tarefa
                else if (targetButton.classList.contains('restore-btn')) {
                    try {
                        await fetch(`/api/updateTask/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'todo' })
                        });
                        showToast('Tarefa restaurada com sucesso!');
                        archivedTasksModalEl.classList.add('hidden');
                    } catch (error) { 
                        console.error("Erro ao restaurar tarefa:", error);
                        showToast('Falha ao restaurar a tarefa.', 'error');
                    }
                }
            });

            // Listener para fechar pop-ups (sugestões e paleta de cores)
            document.addEventListener('click', (e) => {
                const responsibleInput = document.getElementById('taskResponsible');
                const projectInput = document.getElementById('taskProject');
                const colorButton = document.getElementById('color-picker-button');
                const responsibleSuggestions = document.getElementById('responsible-suggestions');
                const projectSuggestions = document.getElementById('project-suggestions');

                // Esconde as sugestões apenas se o clique for fora do input E fora do contentor de sugestões
                if (!responsibleInput.contains(e.target) && !responsibleSuggestions.contains(e.target)) {
                    responsibleSuggestions.classList.add('hidden');
                }
                if (!projectInput.contains(e.target) && !projectSuggestions.contains(e.target)) {
                    projectSuggestions.classList.add('hidden');
                }
                if (!colorButton.contains(e.target)) {
                    document.getElementById('color-palette').classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                const responsibleInput = document.getElementById('taskResponsible');
                const projectInput = document.getElementById('taskProject');
                if (!responsibleInput.contains(e.target)) {
                    document.getElementById('responsible-suggestions').classList.add('hidden');
                }
                if (!projectInput.contains(e.target)) {
                    document.getElementById('project-suggestions').classList.add('hidden');
                }
            });

            document.getElementById('main-content').addEventListener('dblclick', (e) => {
                const descriptionP = e.target.closest('.task-card .description-truncate');
                if (!descriptionP) return;

                const taskCard = descriptionP.closest('.task-card');
                const taskId = taskCard.dataset.taskId;
                const originalText = tasks.find(t => t.id === taskId)?.description || '';

                const input = document.createElement('textarea');
                input.className = 'w-full h-16 p-1 border rounded bg-white/80 dark:bg-custom-dark/80 text-sm';
                input.value = originalText;

                descriptionP.replaceWith(input);
                input.focus();

                const saveChanges = async () => {
                    const newText = input.value.trim();
                    if (newText && newText !== originalText) {
                        taskToHighlightTemporarily = taskId;
                        try {
                            await fetch(`/api/updateTask/${taskId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ description: newText })
                            });
                            showToast('Descrição atualizada!');
                        } catch (error) {
                            console.error("Erro ao atualizar a descrição:", error);
                            showToast('Falha ao atualizar.', 'error');
                        }
                    } else {
                        // Se não houver alterações, a atualização do SignalR irá restaurar o parágrafo
                        await fetchAndRenderTasks();
                    }
                };

                input.addEventListener('blur', saveChanges);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === 'Escape') {
                        // Cancela a edição. A atualização do SignalR irá restaurar.
                        fetchAndRenderTasks();
                    }
                });
            });

            responsibleFilterEl.addEventListener('change', (e) => {
                selectedResponsible = e.target.value;
                updateActiveView();
            });

            viewSwitcherEl.addEventListener('click', (e) => {
                const view = e.target.closest('.view-btn')?.dataset.view;
                if (view && view !== currentView) {
                    currentView = view;

                    // CORREÇÃO: Se mudar para o Kanban, limpa qualquer seleção anterior.
                    if (currentView === 'kanban') {
                        lastInteractedTaskId = null;
                        highlightTask(null);
                    }

                    updateActiveView();
                }
            });

            // --- INICIALIZAÇÃO ---
            // NOVO: Tenta dar play no vídeo de carregamento manualmente
            const loaderVideo = document.getElementById('loader-video');
            if (loaderVideo) {
                loaderVideo.play().catch(error => {
                    console.warn("O autoplay do vídeo foi bloqueado pelo navegador. Isto é normal em alguns ambientes.", error);
                });
            }

            applyTheme();
            fetchAndRenderTasks(); // <-- PEGA AS TAKS PRA NÓS bb
            connectToSignalR(); // <-- Colaborar em tempo real
            initializeDragAndDrop();
            setupCustomColorPicker(); // <-- Componente de cores padrão
            lucide.createIcons();
        });
    </script>
    <!--Toasts-->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>
</body>
</html>